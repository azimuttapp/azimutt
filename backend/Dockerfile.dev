ARG MIX_ENV="dev"

# build stage
FROM hexpm/elixir:1.14.2-erlang-25.1.2-alpine-3.16.2 AS build

# install build dependencies
RUN apk add --no-cache build-base git python3 curl

# sets work dir
WORKDIR /app

# install hex + rebar
RUN mix local.hex --force && \
    mix local.rebar --force

ARG MIX_ENV
ENV MIX_ENV="${MIX_ENV}"

ARG CELLAR_ADDON_KEY_ID
ARG CELLAR_ADDON_HOST
ARG CELLAR_ADDON_KEY_SECRET
ARG CELLAR_BUCKET
ARG CELLAR_ADDON_KEY_ID
ARG CELLAR_ADDON_HOST
ARG CELLAR_ADDON_KEY_SECRET
ARG CELLAR_BUCKET
ARG SECRET_KEY_BASE
ARG GITHUB_CLIENT_SECRET
ARG GITHUB_CLIENT_ID
ARG STRIPE_API_KEY
ARG STRIPE_WEBHOOK_SIGNING_SECRET
ARG POSTGRESQL_ADDON_URI

ENV CELLAR_ADDON_KEY_ID=${CELLAR_ADDON_KEY_ID}
ENV CELLAR_ADDON_HOST=${CELLAR_ADDON_HOST}
ENV CELLAR_ADDON_KEY_SECRET=${CELLAR_ADDON_KEY_SECRET}
ENV CELLAR_BUCKET=${CELLAR_BUCKET}
ENV CELLAR_ADDON_KEY_ID=${CELLAR_ADDON_KEY_ID}
ENV CELLAR_ADDON_HOST=${CELLAR_ADDON_HOST}
ENV CELLAR_ADDON_KEY_SECRET=${CELLAR_ADDON_KEY_SECRET}
ENV CELLAR_BUCKET=${CELLAR_BUCKET}
ENV GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
ENV GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
ENV STRIPE_API_KEY=${STRIPE_API_KEY}
ENV STRIPE_WEBHOOK_SIGNING_SECRET=${STRIPE_WEBHOOK_SIGNING_SECRET}
ENV POSTGRESQL_ADDON_URI=${POSTGRESQL_ADDON_URI}
ENV SECRET_KEY_BASE=${SECRET_KEY_BASE}

COPY . .

RUN mix deps.get --only $MIX_ENV
# compile dependencies
RUN mix deps.compile

# Compile assets
RUN mix assets.deploy
# RUN mix ecto.create
# RUN mix ecto.migrate

CMD ["mix phx.server"]
